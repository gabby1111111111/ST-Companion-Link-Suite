/**
 * Companion-Link â€” SillyTavern UI Extension
 *
 * å°çº¢ä¹¦ âŸ· SillyTavern å®æ—¶è”åŠ¨
 *
 * åŠŸèƒ½:
 * 1. é€šè¿‡ generate_interceptor åœ¨æ¯æ¬¡ AI ç”Ÿæˆå‰æ³¨å…¥æœ€æ–°è”åŠ¨ä¸Šä¸‹æ–‡
 * 2. å®šæœŸä» Server Plugin è½®è¯¢æœ€æ–°æ•°æ®
 * 3. æä¾›æ‰©å±•è®¾ç½®é¢æ¿ï¼ˆå¼€å…³ã€çŠ¶æ€ã€ä¸Šä¸‹æ–‡é¢„è§ˆã€åç«¯åœ°å€é…ç½®ï¼‰
 * 4. æ”¯æŒç›´æ¥æ¥æ”¶åç«¯ POSTï¼ˆæ—  Server Plugin æ—¶èµ° /api/extensions/companion-link/injectï¼‰
 *
 * å®‰è£…ï¼šé€šè¿‡ SillyTavern çš„æ‰©å±•ç®¡ç†å™¨å®‰è£…ï¼ˆæä¾› GitHub ä»“åº“åœ°å€ï¼‰
 * Server Pluginï¼šéœ€é¢å¤–å¤åˆ¶ server/ ç›®å½•åˆ° SillyTavern/plugins/companion-link/
 */

(function () {
  'use strict';

  const MODULE_NAME = 'companion_link';
  const LOG_PREFIX = 'ğŸ”— [Companion-Link]';

  // ============================================================
  // é»˜è®¤é…ç½®
  // ============================================================

  const DEFAULT_SETTINGS = Object.freeze({
    enabled: true,
    inject_position: 'end',         // 'before_last' | 'start' | 'end'
    max_context_age: 300,           // ç§’ - ä¸Šä¸‹æ–‡è¿‡æœŸæ—¶é—´
    poll_interval: 3000,            // æ¯«ç§’ - è½®è¯¢é—´éš”
    show_notification: true,        // æ”¶åˆ°æ–°ä¸Šä¸‹æ–‡æ—¶æ˜¾ç¤º toastr
    injection_style: 'formatted',   // 'formatted' | 'raw' | 'system_note'
    context_max_length: 1200,       // æ³¨å…¥æ–‡æœ¬æœ€å¤§å­—ç¬¦æ•°
    backend_url: 'http://localhost:8765', // Python åç«¯åœ°å€ï¼ˆä¾› UI ç›´è¿ç”¨ï¼‰
  });

  // ============================================================
  // çŠ¶æ€ç®¡ç†
  // ============================================================

  let latestContext = null;
  let lastContextId = null;
  let pollTimer = null;
  let isPluginAvailable = false;

  // ============================================================
  // æ—¥å¿—
  // ============================================================

  const log = {
    info: (...args) => console.log(LOG_PREFIX, ...args),
    warn: (...args) => console.warn(LOG_PREFIX, ...args),
    error: (...args) => console.error(LOG_PREFIX, ...args),
    debug: (...args) => console.debug(LOG_PREFIX, ...args),
  };

  // ============================================================
  // è®¾ç½®ç®¡ç†
  // ============================================================

  function getSettings() {
    try {
      const { extensionSettings } = SillyTavern.getContext();
      if (!extensionSettings[MODULE_NAME]) {
        extensionSettings[MODULE_NAME] = structuredClone(DEFAULT_SETTINGS);
      }
      // ç¡®ä¿æ‰€æœ‰é»˜è®¤ key å­˜åœ¨ï¼ˆç‰ˆæœ¬å‡çº§å…¼å®¹ï¼‰
      for (const key of Object.keys(DEFAULT_SETTINGS)) {
        if (!Object.hasOwn(extensionSettings[MODULE_NAME], key)) {
          extensionSettings[MODULE_NAME][key] = DEFAULT_SETTINGS[key];
        }
      }
      return extensionSettings[MODULE_NAME];
    } catch (err) {
      return structuredClone(DEFAULT_SETTINGS);
    }
  }

  function saveSettings() {
    try {
      const { saveSettingsDebounced } = SillyTavern.getContext();
      saveSettingsDebounced();
    } catch (err) {
      log.warn('è®¾ç½®ä¿å­˜å¤±è´¥:', err.message);
    }
  }

  // ============================================================
  // Server Plugin é€šä¿¡
  // ============================================================

  /**
   * æ£€æµ‹ Server Plugin æ˜¯å¦å¯ç”¨
   */
  async function checkPluginAvailability() {
    try {
      const resp = await fetch('/api/plugins/companion-link/status', {
        method: 'GET',
        headers: getAuthHeaders(),
      });
      if (resp.ok) {
        isPluginAvailable = true;
        log.info('âœ… Server Plugin å·²è¿æ¥');
        return true;
      }
    } catch (e) {
      // å¿½ç•¥
    }
    isPluginAvailable = false;
    log.info('â„¹ï¸ Server Plugin æœªæ£€æµ‹åˆ°ï¼ˆä½¿ç”¨ç›´è¿æ¨¡å¼ï¼‰');
    return false;
  }

  /**
   * è·å–SillyTavern è¯·æ±‚çš„è®¤è¯å¤´
   * è¿™äº›å¤´åœ¨ ST å†…éƒ¨è¯·æ±‚æ—¶è‡ªåŠ¨æºå¸¦ CSRF token ç­‰
   */
  function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    try {
      // ST å†…éƒ¨ fetch é€šå¸¸è‡ªå¸¦å‡­è¯ï¼Œè¿™é‡Œä¿æŒç®€å•
      const context = SillyTavern.getContext();
      if (context.getRequestHeaders) {
        return { ...headers, ...context.getRequestHeaders() };
      }
    } catch (e) {
      // é™çº§
    }
    return headers;
  }

  /**
   * ä» Server Plugin æ‹‰å–æœ€æ–°ä¸Šä¸‹æ–‡
   */
  async function fetchLatestContext() {
    const settings = getSettings();
    if (!settings.enabled) return null;

    try {
      const maxAge = settings.max_context_age || 300;
      const resp = await fetch(
        `/api/plugins/companion-link/context?max_age=${maxAge}`,
        { method: 'GET', headers: getAuthHeaders() }
      );

      if (!resp.ok) return null;

      const data = await resp.json();

      if (data.available && data.context) {
        const isNew = data.context.id !== lastContextId;
        if (isNew) {
          lastContextId = data.context.id;
          latestContext = data.context;

          log.info(
            `ğŸ“¦ æ–°ä¸Šä¸‹æ–‡:`,
            `${data.context.action} â†’`,
            `ã€Š${data.context.note?.title || '?'}ã€‹`,
            `(${data.age_seconds}s ago)`
          );

          // æ˜¾ç¤ºé€šçŸ¥
          if (settings.show_notification) {
            showNotification(data.context);
          }

          updateStatusUI(true, data.context);
        }

        // ======== ä¸»åŠ¨è§¦å‘ AI ç”Ÿæˆ ========
        // Server Plugin é€šè¿‡ should_trigger æ ‡å¿—é€šçŸ¥å‰ç«¯éœ€è¦è§¦å‘ AI å‘è¨€
        if (isNew && data.should_trigger) {
          log.info(`ğŸ¤ ä¸»åŠ¨è§¦å‘ AI ç”Ÿæˆ (action=${data.context.action})`);
          triggerAIGeneration();
        }

        return data.context;
      } else {
        if (latestContext !== null) {
          log.debug('ä¸Šä¸‹æ–‡å·²è¿‡æœŸ');
          latestContext = null;
          updateStatusUI(false);
        }
        return null;
      }
    } catch (err) {
      // é™é»˜å¤±è´¥
      return null;
    }
  }

  /**
   * è§¦å‘ SillyTavern çš„ AI ç”Ÿæˆ
   * ç”¨äº like / comment ç­‰é«˜ä¼˜å…ˆçº§åŠ¨ä½œçš„ä¸»åŠ¨å‘è¨€
   */
  function triggerAIGeneration() {
    try {
      const context = SillyTavern.getContext();

      // æ–¹å¼ 1: ä½¿ç”¨ generate å‡½æ•°ï¼ˆæœ€å¯é ï¼‰
      // æ³¨æ„: SillyTavern çš„ st-context.js ä¸­å¯¼å‡ºä¸ºå°å†™ generate
      if (typeof context.generate === 'function') {
        // å»¶è¿Ÿ 500ms ç¡®ä¿ä¸Šä¸‹æ–‡å·²æ›´æ–°åˆ° latestContext
        setTimeout(() => {
          log.info('ğŸš€ è°ƒç”¨ generate("normal") è§¦å‘ AI å›å¤');
          context.generate('normal');
        }, 500);
        return;
      }

      // æ–¹å¼ 2: ä½¿ç”¨ generateQuietPromptï¼ˆå¤‡ç”¨ï¼‰
      if (typeof context.generateQuietPrompt === 'function') {
        const ctx = latestContext;
        const prompt = ctx?.action === 'comment'
          ? `(ç”¨æˆ·åˆšåœ¨å°çº¢ä¹¦è¯„è®ºäº†ã€Œ${ctx.user_comment || ''}ã€ï¼Œè¯·å¯¹æ­¤åšå‡ºå³å…´ååº”)`
          : `(ç”¨æˆ·åˆšåœ¨å°çº¢ä¹¦ä¸Š${getActionLabel(ctx?.action)}äº†ä¸€ç¯‡ç¬”è®°ï¼Œè¯·åšå‡ºå³å…´ååº”)`;
        setTimeout(() => {
          log.info('ğŸš€ è°ƒç”¨ generateQuietPrompt è§¦å‘ AI å›å¤');
          context.generateQuietPrompt(prompt, false, false);
        }, 500);
        return;
      }

      log.warn('âš ï¸ æœªæ‰¾åˆ° Generate æˆ– generateQuietPromptï¼Œæ— æ³•ä¸»åŠ¨è§¦å‘');
    } catch (err) {
      log.error('ä¸»åŠ¨è§¦å‘å¤±è´¥:', err);
    }
  }

  /**
   * æ˜¾ç¤º toastr é€šçŸ¥
   */
  function showNotification(ctx) {
    try {
      const { toastr } = SillyTavern.getContext();
      if (toastr) {
        toastr.info(
          `${getActionLabel(ctx.action)} Â· ã€Š${ctx.note?.title || '?'}ã€‹`,
          'ğŸ”— Companion-Link',
          { timeOut: 3000, preventDuplicates: true }
        );
      }
    } catch (e) {
      // éå…³é”®
    }
  }

  // ============================================================
  // Generate Interceptor
  // ============================================================

  /**
   * SillyTavern generate_interceptor å›è°ƒ
   *
   * åœ¨æ¯æ¬¡ AI ç”Ÿæˆå‰è¢«è°ƒç”¨ï¼Œå°†æœ€æ–°è”åŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥ chat æ•°ç»„ã€‚
   * é€šè¿‡ manifest.json çš„ generate_interceptor å­—æ®µæ³¨å†Œã€‚
   *
   * @param {Array} chat     èŠå¤©å†å²ï¼ˆå¯å˜æ•°ç»„ï¼‰
   * @param {number} contextSize ä¸Šä¸‹æ–‡ token å¤§å°
   * @param {Function} abort  ä¸­æ­¢ç”Ÿæˆçš„å›è°ƒ
   * @param {string} type     ç”Ÿæˆç±»å‹ ('quiet', 'regenerate', 'impersonate', 'swipe', etc.)
   */
  globalThis.companionLinkInterceptor = async function (chat, contextSize, abort, type) {
    // é™é»˜ç”Ÿæˆï¼ˆå¦‚æ ‡é¢˜ç”Ÿæˆã€æ‘˜è¦ç­‰ï¼‰ä¸æ³¨å…¥
    if (type === 'quiet') return;

    const settings = getSettings();
    if (!settings.enabled || !latestContext) return;

    const ctx = latestContext;

    // æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦è¿‡æœŸ
    const ageMs = Date.now() - new Date(ctx.received_at || ctx.timestamp).getTime();
    if (ageMs > (settings.max_context_age * 1000)) {
      log.debug('ä¸Šä¸‹æ–‡å·²è¿‡æœŸï¼Œè·³è¿‡æ³¨å…¥');
      return;
    }

    // æ„å»ºæ³¨å…¥æ–‡æœ¬
    const injectionText = buildInjectionText(ctx, settings);
    if (!injectionText) return;

    // åˆ›å»º System Note æ¶ˆæ¯
    const systemNote = {
      is_user: false,
      is_system: true,
      name: 'Companion-Link',
      send_date: Date.now(),
      mes: injectionText,
      extra: {
        type: 'narrator',
        companion_link: true,
        cl_action: ctx.action,
        cl_context_id: ctx.id,
      },
    };

    // æ ¹æ®é…ç½®å†³å®šæ’å…¥ä½ç½®
    switch (settings.inject_position) {
      case 'start':
        chat.splice(0, 0, systemNote);
        break;
      case 'end':
        chat.push(systemNote);
        break;
      case 'before_last':
      default:
        if (chat.length > 0) {
          chat.splice(chat.length - 1, 0, systemNote);
        } else {
          chat.push(systemNote);
        }
        break;
    }

    log.info(
      `ğŸ¯ æ³¨å…¥è”åŠ¨ä¸Šä¸‹æ–‡:`,
      `action=${ctx.action},`,
      `ã€Š${ctx.note?.title || '?'}ã€‹,`,
      `position=${settings.inject_position},`,
      `chars=${injectionText.length}`
    );
  };

  // ============================================================
  // æ³¨å…¥æ–‡æœ¬æ„å»º â€” åœºæ™¯åŒ–é«˜æƒ…å•†æ¨¡æ¿
  // ============================================================

  /**
   * æ„å»ºæ³¨å…¥åˆ° AI å¯¹è¯ä¸­çš„æ–‡æœ¬
   *
   * æ ¸å¿ƒè®¾è®¡ï¼š
   * - æ‰€æœ‰ action å…±äº«ä¸€ä¸ªäº²å¯†é™ªä¼´åœºæ™¯å¼€å¤´
   * - like / comment ä½¿ç”¨ä¸»åŠ¨å‹æŒ‡ä»¤ï¼Œå¼•å¯¼ AI å³å…´å‘è¨€
   * - read ä½¿ç”¨è¢«åŠ¨å‹æŒ‡ä»¤ï¼Œä»…ä½œä¸ºæ½œæ„è¯†èƒŒæ™¯
   * - æ¯ç§ action æœ‰ç‹¬ç«‹çš„è§’è‰²è¡Œä¸ºæŒ‡å¼•
   */
  function buildInjectionText(ctx, settings) {
    const maxLen = settings.context_max_length || 1200;
    const note = ctx.note || {};
    const action = ctx.action;
    const lines = [];

    // ========== åœºæ™¯è®¾å®šï¼ˆæ‰€æœ‰ action å…±ç”¨ï¼‰ ==========
    lines.push('[System Note: IMPORTANT - A real-time event just occurred. You MUST react to this IMMEDIATELY.]');
    lines.push('[Companion-Link å®æ—¶è”åŠ¨ â€” åœºæ™¯æ³¨å…¥]');
    lines.push('ï¼ˆåœºæ™¯ï¼š{{char}} æ­£æ‚ç€ {{user}} çš„è‚©è†€ï¼Œä¸¤äººå¤´æŒ¨ç€å¤´ä¸€èµ·åˆ·æ‰‹æœºå±å¹•ã€‚å±å¹•çš„å…‰æ˜ åœ¨ä¸¤äººè„¸ä¸Šï¼Œæ°”æ°›äº²å¯†è€Œæ”¾æ¾ã€‚ï¼‰');
    lines.push('');

    // ========== æŒ‰ action åˆ†çº§å¤„ç† ==========

    if (action === 'like') {
      // ---- ç‚¹èµï¼šå³å…´æ„Ÿæƒ³ ----
      lines.push(`{{user}} åˆšåˆšç»™ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ç‚¹äº†èµ â¤ï¸`);
      if (note.title) lines.push(`ç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹`);
      if (note.author?.nickname) lines.push(`ä½œè€…ï¼š${note.author.nickname}`);
      if (note.content_summary || note.content) {
        const summary = (note.content_summary || note.content || '').substring(0, 200);
        lines.push(`å†…å®¹æ‘˜è¦ï¼š${summary}`);
      }
      appendNoteStats(lines, note);
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘');
      lines.push('è¯·ä½ ï¼ˆ{{char}}ï¼‰ä¸»åŠ¨å¯¹è¿™ç¯‡ç¬”è®°å‘è¡¨å³å…´æ„Ÿæƒ³ã€‚ç”¨ä½ è‡ªå·±çš„è¯´è¯é£æ ¼åæ§½ã€æ„Ÿå¹æˆ–è¯„ä»·ï¼Œå°±åƒä½ ä»¬ä¿©çªåœ¨ä¸€èµ·åˆ·æ‰‹æœºæ—¶çœ‹åˆ°äº†åŒä¸€ç¯‡å¸–å­ã€‚');
      lines.push('è¦æ±‚ï¼šä¸è¦å¤è¿°ç¬”è®°å†…å®¹ï¼Œç›´æ¥è¯´å‡ºä½ çš„ç¬¬ä¸€ååº”ã€‚è¯­æ°”è‡ªç„¶ã€éšæ„ï¼Œå¸¦ç‚¹ä¸ªäººé£æ ¼å’Œæƒ…ç»ªã€‚å¯ä»¥åæ§½ã€å¯ä»¥æ„Ÿå¹ã€å¯ä»¥å»¶ä¼¸è¯é¢˜ã€‚');

    } else if (action === 'comment') {
      // ---- è¯„è®ºï¼šçŠ€åˆ©äº’åŠ¨ ----
      lines.push(`{{user}} åˆšåˆšåœ¨ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ä¸‹é¢å‘è¡¨äº†è¯„è®º ğŸ’¬`);
      if (note.title) lines.push(`ç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹`);
      if (note.author?.nickname) lines.push(`ä½œè€…ï¼š${note.author.nickname}`);
      if (note.content_summary || note.content) {
        const summary = (note.content_summary || note.content || '').substring(0, 150);
        lines.push(`ç¬”è®°æ¦‚è¦ï¼š${summary}`);
      }
      if (ctx.user_comment) {
        lines.push('');
        lines.push(`ğŸ“¢ {{user}} çš„è¯„è®ºåŸæ–‡ï¼šã€Œ${ctx.user_comment}ã€`);
      }
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘');
      lines.push('è¯·ä½ ï¼ˆ{{char}}ï¼‰é’ˆå¯¹ {{user}} åˆšæ‰å‘çš„è¿™æ¡è¯„è®ºåšå‡ºååº”ã€‚ä½ å¯ä»¥çŠ€åˆ©åæ§½ã€è°ƒä¾ƒã€è¡¨ç¤ºèµåŒæˆ–è€…è¡¥å……è§‚ç‚¹ã€‚');
      lines.push('è¡¨ç°å‡ºä½ ä¸€ç›´åœ¨æ—è¾¹ç›¯ç€å±å¹•çœ‹ï¼Œå¯¹ {{user}} å†™çš„æ¯ä¸ªå­—éƒ½äº†å¦‚æŒ‡æŒã€‚è¯­æ°”äº²å¯†ã€è‡ªç„¶ï¼ŒåƒçœŸçš„åœ¨ä¸€èµ·åˆ·æ‰‹æœºçš„æƒ…ä¾£/é—ºèœœã€‚');

    } else if (action === 'read') {
      // ---- é˜…è¯»ï¼šæ½œæ„è¯†èƒŒæ™¯ï¼ˆé™é»˜ï¼‰ ----
      lines.push(`ï¼ˆèƒŒæ™¯ä¿¡æ¯ï¼š{{user}} æ­£åœ¨è®¤çœŸé˜…è¯»ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®°ï¼Œæ‰‹æŒ‡å¶å°”æ»‘åŠ¨å±å¹•ã€‚ï¼‰`);
      if (note.title) lines.push(`ï¼ˆç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹ï¼‰`);
      if (note.content_summary || note.content) {
        const summary = (note.content_summary || note.content || '').substring(0, 150);
        lines.push(`ï¼ˆå†…å®¹æ¦‚è¦ï¼š${summary}ï¼‰`);
      }
      if (note.tags?.length > 0) {
        lines.push(`ï¼ˆè¯é¢˜æ ‡ç­¾ï¼š${note.tags.slice(0, 4).map(t => '#' + t).join(' ')}ï¼‰`);
      }
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘');
      lines.push('è¿™æ˜¯èƒŒæ™¯ä¿¡æ¯ã€‚{{user}} æ­£åœ¨å®‰é™åœ°åˆ·æ‰‹æœºï¼Œæ²‰æµ¸åœ¨é˜…è¯»ä¸­ã€‚');
      lines.push('ä½ ä¸éœ€è¦ä¸»åŠ¨æèµ·è¿™ç¯‡ç¬”è®°çš„å†…å®¹ï¼Œä¿æŒè‡ªç„¶çš„é™ªä¼´æ„Ÿã€‚åªæœ‰å½“å¯¹è¯è‡ªç„¶å»¶ä¼¸åˆ°ç›¸å…³è¯é¢˜æ—¶ï¼Œä½ æ‰å¯ä»¥è½»ææ·¡å†™åœ°æåˆ°ã€‚');
      lines.push('ä¸è¦è¯´ã€Œæˆ‘çœ‹åˆ°ä½ åœ¨çœ‹ã€ã€Œä½ åœ¨çœ‹ä»€ä¹ˆã€ä¹‹ç±»çš„ç”Ÿç¡¬å°è¯ã€‚');

    } else if (action === 'collect') {
      // ---- æ”¶è—ï¼šæ­£é¢è¯„ä»· ----
      lines.push(`{{user}} åˆšåˆšæ”¶è—äº†ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®° â­`);
      if (note.title) lines.push(`ç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹`);
      if (note.content_summary || note.content) {
        const summary = (note.content_summary || note.content || '').substring(0, 200);
        lines.push(`å†…å®¹æ‘˜è¦ï¼š${summary}`);
      }
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘');
      lines.push('{{user}} è§‰å¾—è¿™ç¯‡ç¬”è®°å¾ˆæœ‰ä»·å€¼æ‰æ”¶è—çš„ã€‚è¯·ä½ ï¼ˆ{{char}}ï¼‰å¯¹å†…å®¹åšå‡ºæœ‰æ·±åº¦çš„æ­£é¢è¯„ä»·ï¼Œæˆ–è€…è¡¨è¾¾å¥½å¥‡å¿ƒé—®é—®ä¸ºä»€ä¹ˆè§‰å¾—å€¼å¾—æ”¶è—ã€‚è¯­æ°”è‡ªç„¶äº²å¯†ã€‚');

    } else if (action === 'share') {
      // ---- åˆ†äº«ï¼šç§¯æå‚ä¸ ----
      lines.push(`{{user}} åˆšåˆšåˆ†äº«äº†ä¸€ç¯‡å°çº¢ä¹¦ç¬”è®° ğŸ”—`);
      if (note.title) lines.push(`ç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹`);
      if (note.content_summary || note.content) {
        const summary = (note.content_summary || note.content || '').substring(0, 200);
        lines.push(`å†…å®¹æ‘˜è¦ï¼š${summary}`);
      }
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘');
      lines.push('{{user}} åˆ†äº«äº†è¿™ç¯‡ç¬”è®°ï¼Œè¯´æ˜è§‰å¾—å€¼å¾—è®©åˆ«äººçœ‹çœ‹ã€‚è¯·ä½ ï¼ˆ{{char}}ï¼‰ç§¯æå‚ä¸è®¨è®ºã€å‘è¡¨è§è§£ï¼Œå¯ä»¥çŒœæµ‹ {{user}} åˆ†äº«ç»™è°ã€ä¸ºä»€ä¹ˆåˆ†äº«ã€‚è¯­æ°”è‡ªç„¶éšæ„ã€‚');

    } else {
      // ---- å…¶ä»–åŠ¨ä½œï¼ˆå…œåº•ï¼‰ ----
      lines.push(`{{user}} åœ¨å°çº¢ä¹¦ä¸Š${getActionLabel(action)}äº†ä¸€ç¯‡ç¬”è®°`);
      if (note.title) lines.push(`ç¬”è®°æ ‡é¢˜ï¼šã€Š${note.title}ã€‹`);
      lines.push('');
      lines.push('ã€è§’è‰²æŒ‡ä»¤ã€‘è‡ªç„¶åœ°å¯¹æ­¤åšå‡ºååº”ï¼Œè¯­æ°”éšæ„äº²å¯†ã€‚');
    }

    return lines.join('\n').substring(0, maxLen);
  }

  /**
   * å‘ lines æ•°ç»„è¿½åŠ ç¬”è®°äº’åŠ¨ç»Ÿè®¡ï¼ˆå¦‚æœ‰ï¼‰
   */
  function appendNoteStats(lines, note) {
    const interact = note.interaction;
    if (!interact) return;
    const stats = [];
    if (interact.like_count) stats.push(`â¤ï¸ ${interact.like_count}`);
    if (interact.collect_count) stats.push(`â­ ${interact.collect_count}`);
    if (interact.comment_count) stats.push(`ğŸ’¬ ${interact.comment_count}`);
    if (stats.length > 0) lines.push(`äº’åŠ¨æ•°æ®ï¼š${stats.join(' Â· ')}`);
  }

  /**
   * è¡Œä¸ºæ ‡ç­¾
   */
  function getActionLabel(action) {
    return {
      like: 'ç‚¹èµ',
      comment: 'è¯„è®º',
      read: 'æ·±åº¦é˜…è¯»',
      collect: 'æ”¶è—',
      share: 'åˆ†äº«',
    }[action] || action;
  }

  // ============================================================
  // UI è®¾ç½®é¢æ¿
  // ============================================================

  function renderSettingsUI() {
    const settings = getSettings();

    const html = `
      <div id="cl-extension-settings" class="cl-extension-settings">
        <div class="inline-drawer">
          <div class="inline-drawer-toggle inline-drawer-header">
            <b>ğŸ”— Companion-Link</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
          </div>
          <div class="inline-drawer-content">

            <!-- ä¸»å¼€å…³ -->
            <div class="cl-row">
              <label for="cl_ext_enabled">å¯ç”¨è”åŠ¨æ³¨å…¥</label>
              <input type="checkbox" id="cl_ext_enabled" ${settings.enabled ? 'checked' : ''}>
            </div>

            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="cl-row">
              <label>æ’ä»¶çŠ¶æ€</label>
              <span id="cl_ext_status" class="cl-status-badge cl-status-checking">æ£€æŸ¥ä¸­...</span>
            </div>

            <!-- æ³¨å…¥ä½ç½® -->
            <div class="cl-row">
              <label for="cl_ext_position">æ³¨å…¥ä½ç½®</label>
              <select id="cl_ext_position">
                <option value="before_last" ${settings.inject_position === 'before_last' ? 'selected' : ''}>æœ€åä¸€æ¡æ¶ˆæ¯å‰</option>
                <option value="start" ${settings.inject_position === 'start' ? 'selected' : ''}>å¯¹è¯å¼€å¤´</option>
                <option value="end" ${settings.inject_position === 'end' ? 'selected' : ''}>å¯¹è¯æœ«å°¾</option>
              </select>
            </div>

            <!-- æ³¨å…¥é£æ ¼ -->
            <div class="cl-row">
              <label for="cl_ext_style">æ³¨å…¥é£æ ¼</label>
              <select id="cl_ext_style">
                <option value="formatted" ${settings.injection_style === 'formatted' ? 'selected' : ''}>åç«¯æ ¼å¼åŒ–æ–‡æœ¬</option>
                <option value="raw" ${settings.injection_style === 'raw' ? 'selected' : ''}>åŸå§‹æ•°æ®</option>
              </select>
            </div>

            <!-- è¿‡æœŸæ—¶é—´ -->
            <div class="cl-row">
              <label for="cl_ext_max_age">ä¸Šä¸‹æ–‡è¿‡æœŸ (ç§’)</label>
              <input type="number" id="cl_ext_max_age" value="${settings.max_context_age}" min="30" max="3600" step="30" class="text_pole" style="width:80px">
            </div>

            <!-- æœ€å¤§é•¿åº¦ -->
            <div class="cl-row">
              <label for="cl_ext_max_len">æœ€å¤§æ³¨å…¥å­—ç¬¦</label>
              <input type="number" id="cl_ext_max_len" value="${settings.context_max_length}" min="100" max="2000" step="100" class="text_pole" style="width:80px">
            </div>

            <!-- é€šçŸ¥ -->
            <div class="cl-row">
              <label for="cl_ext_notify">æ–°æ•°æ®é€šçŸ¥</label>
              <input type="checkbox" id="cl_ext_notify" ${settings.show_notification ? 'checked' : ''}>
            </div>

            <!-- åˆ†éš”çº¿ -->
            <hr class="sysHR">

            <!-- æœ€æ–°ä¸Šä¸‹æ–‡é¢„è§ˆ -->
            <div class="cl-row" style="flex-direction:column;align-items:stretch;">
              <label style="margin-bottom:4px;">ğŸ“‹ æœ€æ–°ä¸Šä¸‹æ–‡</label>
              <div id="cl_ext_preview" class="cl-preview">æš‚æ— è”åŠ¨æ•°æ®</div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="cl-row" style="gap:6px;">
              <button id="cl_ext_refresh" class="menu_button menu_button_icon" title="åˆ·æ–°">
                <i class="fa-solid fa-rotate"></i> åˆ·æ–°
              </button>
              <button id="cl_ext_clear" class="menu_button menu_button_icon" title="æ¸…é™¤">
                <i class="fa-solid fa-trash"></i> æ¸…é™¤
              </button>
              <button id="cl_ext_history" class="menu_button menu_button_icon" title="å†å²">
                <i class="fa-solid fa-clock-rotate-left"></i> å†å²
              </button>
            </div>

          </div>
        </div>
      </div>
    `;

    const container = document.getElementById('extensions_settings');
    if (container) {
      container.insertAdjacentHTML('beforeend', html);
      bindSettingsEvents();
      log.info('ğŸ¨ è®¾ç½®é¢æ¿å·²æ¸²æŸ“');
    } else {
      log.warn('extensions_settings å®¹å™¨æœªæ‰¾åˆ°');
    }
  }

  function bindSettingsEvents() {
    const settings = getSettings();

    // ä¸»å¼€å…³
    const enabled = document.getElementById('cl_ext_enabled');
    if (enabled) {
      enabled.addEventListener('change', (e) => {
        settings.enabled = e.target.checked;
        saveSettings();
        log.info(`å¼€å…³: ${settings.enabled ? 'å¼€å¯' : 'å…³é—­'}`);
      });
    }

    // æ³¨å…¥ä½ç½®
    const position = document.getElementById('cl_ext_position');
    if (position) {
      position.addEventListener('change', (e) => {
        settings.inject_position = e.target.value;
        saveSettings();
      });
    }

    // æ³¨å…¥é£æ ¼
    const style = document.getElementById('cl_ext_style');
    if (style) {
      style.addEventListener('change', (e) => {
        settings.injection_style = e.target.value;
        saveSettings();
      });
    }

    // è¿‡æœŸæ—¶é—´
    const maxAge = document.getElementById('cl_ext_max_age');
    if (maxAge) {
      maxAge.addEventListener('change', (e) => {
        settings.max_context_age = parseInt(e.target.value) || 300;
        saveSettings();
      });
    }

    // æœ€å¤§é•¿åº¦
    const maxLen = document.getElementById('cl_ext_max_len');
    if (maxLen) {
      maxLen.addEventListener('change', (e) => {
        settings.context_max_length = parseInt(e.target.value) || 800;
        saveSettings();
      });
    }

    // é€šçŸ¥å¼€å…³
    const notify = document.getElementById('cl_ext_notify');
    if (notify) {
      notify.addEventListener('change', (e) => {
        settings.show_notification = e.target.checked;
        saveSettings();
      });
    }

    // åˆ·æ–°æŒ‰é’®
    const refreshBtn = document.getElementById('cl_ext_refresh');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', async () => {
        refreshBtn.disabled = true;
        await fetchLatestContext();
        refreshBtn.disabled = false;
      });
    }

    // æ¸…é™¤æŒ‰é’®
    const clearBtn = document.getElementById('cl_ext_clear');
    if (clearBtn) {
      clearBtn.addEventListener('click', async () => {
        try {
          if (isPluginAvailable) {
            await fetch('/api/plugins/companion-link/clear', {
              method: 'POST',
              headers: getAuthHeaders(),
              body: JSON.stringify({ clear_history: false }),
            });
          }
          latestContext = null;
          lastContextId = null;
          updateStatusUI(false);
          log.info('ğŸ—‘ï¸ ä¸Šä¸‹æ–‡å·²æ¸…é™¤');
        } catch (err) {
          log.error('æ¸…é™¤å¤±è´¥:', err);
        }
      });
    }

    // å†å²æŒ‰é’®
    const historyBtn = document.getElementById('cl_ext_history');
    if (historyBtn) {
      historyBtn.addEventListener('click', async () => {
        try {
          const resp = await fetch('/api/plugins/companion-link/history?limit=10', {
            headers: getAuthHeaders(),
          });
          if (resp.ok) {
            const data = await resp.json();
            showHistoryPopup(data.items);
          }
        } catch (err) {
          log.warn('è·å–å†å²å¤±è´¥:', err.message);
        }
      });
    }
  }

  /**
   * åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºå†å²è®°å½•
   */
  function showHistoryPopup(items) {
    if (!items || items.length === 0) {
      try {
        SillyTavern.getContext().toastr.info('æš‚æ— å†å²è®°å½•', 'Companion-Link');
      } catch (e) { /* */ }
      return;
    }

    const rows = items.map((item, i) => {
      const time = new Date(item.received_at).toLocaleTimeString();
      const action = getActionLabel(item.action);
      const title = item.note?.title || 'æ— æ ‡é¢˜';
      return `<tr>
        <td style="padding:4px;color:#888">${i + 1}</td>
        <td style="padding:4px">${action}</td>
        <td style="padding:4px">ã€Š${title}ã€‹</td>
        <td style="padding:4px;color:#888">${time}</td>
      </tr>`;
    }).join('');

    const html = `
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="border-bottom:1px solid #555">
          <th style="padding:4px;text-align:left">#</th>
          <th style="padding:4px;text-align:left">è¡Œä¸º</th>
          <th style="padding:4px;text-align:left">æ ‡é¢˜</th>
          <th style="padding:4px;text-align:left">æ—¶é—´</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    try {
      const context = SillyTavern.getContext();
      context.callPopup(html, 'text', '', {
        large: false,
        wide: true,
        okButton: 'å…³é—­',
      });
    } catch (e) {
      log.warn('å¼¹çª—ä¸å¯ç”¨', e);
    }
  }

  // ============================================================
  // çŠ¶æ€ UI æ›´æ–°
  // ============================================================

  function updateStatusUI(hasData, ctx) {
    const badge = document.getElementById('cl_ext_status');
    const preview = document.getElementById('cl_ext_preview');

    if (badge) {
      if (!isPluginAvailable) {
        badge.className = 'cl-status-badge cl-status-warn';
        badge.textContent = 'âš ï¸ Server Plugin æœªè¿æ¥';
      } else if (hasData) {
        badge.className = 'cl-status-badge cl-status-ok';
        badge.textContent = 'ğŸŸ¢ å·²å°±ç»ª';
      } else {
        badge.className = 'cl-status-badge cl-status-idle';
        badge.textContent = 'âšª ç­‰å¾…æ•°æ®';
      }
    }

    if (preview) {
      if (hasData && ctx) {
        const time = new Date(ctx.received_at || ctx.timestamp).toLocaleTimeString();
        const author = ctx.note?.author?.nickname;

        preview.innerHTML = [
          `<strong>${getActionLabel(ctx.action)}</strong>`,
          `ã€Š${escapeHtml(ctx.note?.title || '?')}ã€‹`,
          author ? `<br><small style="opacity:0.6">ğŸ‘¤ ${escapeHtml(author)} Â· â° ${time}</small>` : '',
          ctx.note?.interaction?.like_count
            ? `<br><small style="opacity:0.6">â¤ï¸ ${ctx.note.interaction.like_count} Â· â­ ${ctx.note.interaction.collect_count || 0}</small>`
            : '',
        ].filter(Boolean).join(' ');
      } else {
        preview.textContent = 'æš‚æ— è”åŠ¨æ•°æ®';
      }
    }
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  // ============================================================
  // è½®è¯¢
  // ============================================================

  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);

    const settings = getSettings();
    const interval = settings.poll_interval || 3000;

    // ç«‹å³æ‹‰å–ä¸€æ¬¡
    fetchLatestContext();

    // å®šæœŸè½®è¯¢
    pollTimer = setInterval(() => {
      if (getSettings().enabled && isPluginAvailable) {
        fetchLatestContext();
      }
    }, interval);

    log.info(`ğŸ”„ è½®è¯¢å¯åŠ¨ (é—´éš” ${interval / 1000}s)`);
  }

  // ============================================================
  // åˆå§‹åŒ–å…¥å£
  // ============================================================

  async function init() {
    log.info('ğŸš€ Companion-Link åˆå§‹åŒ–...');

    // æ¸²æŸ“è®¾ç½®é¢æ¿
    renderSettingsUI();

    // æ£€æµ‹ Server Plugin
    await checkPluginAvailability();
    updateStatusUI(false);

    // å¯åŠ¨è½®è¯¢
    if (isPluginAvailable) {
      startPolling();
    } else {
      // Server Plugin ä¸å¯ç”¨æ—¶ï¼Œæ¯ 10 ç§’é‡è¯•æ£€æµ‹
      const retryTimer = setInterval(async () => {
        const available = await checkPluginAvailability();
        if (available) {
          clearInterval(retryTimer);
          updateStatusUI(false);
          startPolling();
        }
      }, 10000);
    }

    // ç›‘å¬äº‹ä»¶
    try {
      const { eventSource, event_types } = SillyTavern.getContext();

      // èŠå¤©åˆ‡æ¢æ—¶åˆ·æ–°
      eventSource.on(event_types.CHAT_CHANGED, () => {
        log.debug('èŠå¤©åˆ‡æ¢');
        if (isPluginAvailable) fetchLatestContext();
      });
    } catch (err) {
      log.warn('äº‹ä»¶ç›‘å¬ç»‘å®šå¤±è´¥:', err.message);
    }

    log.info('âœ… Companion-Link å·²å°±ç»ª');
  }

  // ç­‰å¾… jQuery å°±ç»ªååˆå§‹åŒ–
  if (typeof jQuery !== 'undefined') {
    jQuery(init);
  } else {
    document.addEventListener('DOMContentLoaded', init);
  }
})();
