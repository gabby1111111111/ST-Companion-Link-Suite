============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-9.0.2, pluggy-1.6.0 -- E:\ST-Companion-Link\backend\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: e:\ST-Companion-Link\backend
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_extractor.py::TestExtractFromInitialState::test_undefined_in_json FAILED [100%]

================================== FAILURES ===================================
_____________ TestExtractFromInitialState.test_undefined_in_json ______________

self = <test_extractor.TestExtractFromInitialState object at 0x000002913E5725F0>

    def test_undefined_in_json(self):
        """JSON 中包含 JavaScript 的 undefined 关键字"""
        state = {
            "note": {
                "noteDetailMap": {
                    "abc123": {
                        "note": {
                            "title": "含undefined笔记",
                            "desc": "测试",
                            "type": "normal",
                            "user": {"nickname": "作者"},
                            "interactInfo": {},
                        }
                    }
                }
            }
        }
        json_str = json.dumps(state, ensure_ascii=False)
        # 手动插入 undefined
        json_str = json_str.replace('"测试"', "undefined")
        html = f"<script>window.__INITIAL_STATE__={json_str};</script>"
    
        result = self.ext._extract_from_initial_state(
            html, "abc123", "https://example.com"
        )
    
>       assert result is not None
E       assert None is not None

tests\test_extractor.py:251: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  companion-link.extractor:extractor.py:204 \u26a0\ufe0f __INITIAL_STATE__ \u89e3\u6790\u5931\u8d25: 1 validation error for NoteData\ncontent\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type
=========================== short test summary info ===========================
FAILED tests/test_extractor.py::TestExtractFromInitialState::test_undefined_in_json
============================== 1 failed in 0.76s ==============================
